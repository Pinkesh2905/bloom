{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
  .filter-sidebar {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
  }
  
  .therapist-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
  }
  
  .therapist-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  }
  
  .rating-stars {
    color: #fbbf24;
    font-size: 1.1rem;
  }
  
  .specialization-tag {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    display: inline-block;
    margin: 0.125rem;
    font-weight: 500;
  }
  
  .search-bar {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }
  
  .search-bar:focus {
    border-color: #8b5cf6;
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
  }
  
  .filter-checkbox {
    accent-color: #8b5cf6;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-fade-in-up {
    animation: fadeInUp 0.6s ease-out;
  }
  
  /* Staggered animation delays using nth-child */
  .therapist-card:nth-child(1) { animation-delay: 0ms; }
  .therapist-card:nth-child(2) { animation-delay: 100ms; }
  .therapist-card:nth-child(3) { animation-delay: 200ms; }
  .therapist-card:nth-child(4) { animation-delay: 300ms; }
  .therapist-card:nth-child(5) { animation-delay: 400ms; }
  .therapist-card:nth-child(6) { animation-delay: 500ms; }
  .therapist-card:nth-child(7) { animation-delay: 600ms; }
  .therapist-card:nth-child(8) { animation-delay: 700ms; }
  .therapist-card:nth-child(9) { animation-delay: 800ms; }
  .therapist-card:nth-child(n+10) { animation-delay: 900ms; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header Section -->
  <div class="text-center mb-12 animate-fade-in-up">
    <h1 class="text-5xl font-extrabold font-fredoka mb-4">
      <span class="bg-gradient-to-r from-purple-600 via-pink-500 to-blue-600 bg-clip-text text-transparent">
        Find Your Perfect Therapist
      </span>
    </h1>
    <p class="text-xl text-gray-600 font-dm max-w-3xl mx-auto">
      Connect with our verified mental health professionals. We have {{ total_count }} qualified therapists ready to support your journey.
    </p>
  </div>

  <!-- Search and Filter Section -->
  <div class="mb-8">
    <form method="GET" class="space-y-6">
      <!-- Main Search Bar -->
      <div class="relative">
        <input
          type="text"
          name="search_query"
          value="{{ form.search_query.value|default:'' }}"
          placeholder="Search by name, specialization, or approach..."
          class="search-bar w-full px-6 py-4 text-lg rounded-2xl focus:outline-none font-dm"
        />
        <button type="submit" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-purple-500 hover:text-purple-700">
          <i class="fas fa-search text-xl"></i>
        </button>
      </div>

      <!-- Advanced Filters Toggle -->
      <div class="text-center">
        <button type="button" id="toggle-filters" class="text-purple-600 hover:text-purple-800 font-semibold">
          <i class="fas fa-filter mr-2"></i>Advanced Filters
          <i class="fas fa-chevron-down ml-2" id="filter-arrow"></i>
        </button>
      </div>

      <!-- Advanced Filters Panel -->
      <div id="filters-panel" class="filter-sidebar p-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Specializations -->
          <div>
            <h3 class="font-semibold text-gray-800 mb-3 font-fredoka">Specializations</h3>
            <div class="max-h-48 overflow-y-auto space-y-2">
              {% for value, label in form.specializations.field.choices %}
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="specializations" value="{{ value }}" 
                         class="filter-checkbox rounded"
                         {% if value in form.specializations.value %}checked{% endif %}>
                  <span class="text-sm text-gray-700">{{ label }}</span>
                </label>
              {% endfor %}
            </div>
          </div>

          <!-- Session Types -->
          <div>
            <h3 class="font-semibold text-gray-800 mb-3 font-fredoka">Session Types</h3>
            <div class="space-y-2">
              {% for value, label in form.session_types.field.choices %}
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="session_types" value="{{ value }}" 
                         class="filter-checkbox rounded"
                         {% if value in form.session_types.value %}checked{% endif %}>
                  <span class="text-sm text-gray-700">{{ label }}</span>
                </label>
              {% endfor %}
            </div>
          </div>

          <!-- Languages -->
          <div>
            <h3 class="font-semibold text-gray-800 mb-3 font-fredoka">Languages</h3>
            <div class="max-h-48 overflow-y-auto space-y-2">
              {% for value, label in form.languages.field.choices %}
                <label class="flex items-center space-x-2">
                  <input type="checkbox" name="languages" value="{{ value }}" 
                         class="filter-checkbox rounded"
                         {% if value in form.languages.value %}checked{% endif %}>
                  <span class="text-sm text-gray-700">{{ label }}</span>
                </label>
              {% endfor %}
            </div>
          </div>

          <!-- Price and Rating -->
          <div class="space-y-4">
            <div>
              <h3 class="font-semibold text-gray-800 mb-3 font-fredoka">Max Rate</h3>
              <input type="number" name="max_rate" value="{{ form.max_rate.value|default:'' }}"
                     placeholder="$200/hour" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-purple-500">
            </div>
            
            <div>
              <h3 class="font-semibold text-gray-800 mb-3 font-fredoka">Min Rating</h3>
              <select name="min_rating" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-purple-500">
                <option value="">Any Rating</option>
                <option value="4.5" {% if form.min_rating.value == "4.5" %}selected{% endif %}>4.5+ Stars</option>
                <option value="4.0" {% if form.min_rating.value == "4.0" %}selected{% endif %}>4.0+ Stars</option>
                <option value="3.5" {% if form.min_rating.value == "3.5" %}selected{% endif %}>3.5+ Stars</option>
              </select>
            </div>
            
            <div>
              <label class="flex items-center space-x-2">
                <input type="checkbox" name="accepts_insurance" value="true" 
                       class="filter-checkbox rounded"
                       {% if form.accepts_insurance.value %}checked{% endif %}>
                <span class="text-sm text-gray-700">Accepts Insurance</span>
              </label>
            </div>
          </div>
        </div>

        <div class="mt-6 flex space-x-4">
          <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all font-semibold">
            Apply Filters
          </button>
          <a href="{% url 'therapists:therapist_list' %}" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-semibold">
            Clear All
          </a>
        </div>
      </div>
    </form>
  </div>

  <!-- Results Summary -->
  {% if has_search %}
    <div class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
      <p class="text-blue-800 font-semibold">
        <i class="fas fa-search mr-2"></i>
        Found {{ total_count }} therapist{{ total_count|pluralize }} matching your criteria
      </p>
    </div>
  {% endif %}

  <!-- Popular Specializations -->
  {% if popular_specializations and not has_search %}
    <div class="mb-8">
      <h2 class="text-2xl font-bold font-fredoka text-gray-800 mb-4">Popular Specializations</h2>
      <div class="flex flex-wrap gap-2">
        {% for spec, count in popular_specializations %}
          <a href="?specializations={{ spec }}" class="specialization-tag hover:scale-105 transition-transform">
            {{ spec|title }} ({{ count }})
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- Sorting Options -->
  <div class="mb-6 flex justify-between items-center">
    <p class="text-gray-600 font-dm">
      Showing {{ therapists.start_index }}-{{ therapists.end_index }} of {{ total_count }} therapists
    </p>
    
    <div class="flex items-center space-x-2">
      <label class="text-sm text-gray-600 font-dm">Sort by:</label>
      <select name="sort_by" onchange="this.form.submit()" class="px-3 py-2 rounded-lg border focus:ring-2 focus:ring-purple-500 text-sm">
        <option value="rating" {% if form.sort_by.value == "rating" %}selected{% endif %}>Highest Rated</option>
        <option value="experience" {% if form.sort_by.value == "experience" %}selected{% endif %}>Most Experienced</option>
        <option value="rate_low" {% if form.sort_by.value == "rate_low" %}selected{% endif %}>Lowest Rate</option>
        <option value="response_time" {% if form.sort_by.value == "response_time" %}selected{% endif %}>Fastest Response</option>
        <option value="newest" {% if form.sort_by.value == "newest" %}selected{% endif %}>Newest</option>
      </select>
    </div>
  </div>

  <!-- Therapist Cards Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    {% for therapist in therapists %}
      <div class="therapist-card rounded-3xl p-6 shadow-lg animate-fade-in-up">
        <!-- Therapist Header -->
        <div class="flex items-start space-x-4 mb-4">
          <div class="relative">
            <img class="h-20 w-20 rounded-2xl object-cover shadow-md" 
                 src="{{ therapist.profile_picture.url }}" 
                 alt="{{ therapist.full_name }}">
            <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-400 rounded-full border-2 border-white"></div>
          </div>
          
          <div class="flex-1">
            <h3 class="text-xl font-bold font-fredoka text-gray-800 mb-1">
              Dr. {{ therapist.full_name }}
            </h3>
            <div class="flex items-center mb-2">
              <div class="rating-stars mr-2">
                {% for i in "12345" %}
                  {% if forloop.counter <= therapist.rating %}
                    <i class="fas fa-star"></i>
                  {% else %}
                    <i class="far fa-star"></i>
                  {% endif %}
                {% endfor %}
              </div>
              <span class="text-sm text-gray-600 font-dm">
                {{ therapist.rating|floatformat:1 }} ({{ therapist.total_reviews }} review{{ therapist.total_reviews|pluralize }})
              </span>
            </div>
            <div class="text-lg font-bold text-green-600">
              ${{ therapist.hourly_rate }}/session
            </div>
          </div>
        </div>

        <!-- Experience and Languages -->
        <div class="mb-4 space-y-2">
          <div class="flex items-center text-sm text-gray-600">
            <i class="fas fa-user-md mr-2 text-purple-500"></i>
            {{ therapist.years_experience }} year{{ therapist.years_experience|pluralize }} experience
          </div>
          
          {% if therapist.languages_display %}
            <div class="flex items-center text-sm text-gray-600">
              <i class="fas fa-globe mr-2 text-purple-500"></i>
              {{ therapist.languages_display|join:", " }}
            </div>
          {% endif %}
          
          <div class="flex items-center text-sm text-gray-600">
            <i class="fas fa-clock mr-2 text-purple-500"></i>
            Responds in {{ therapist.response_time_hours }}h typically
          </div>
        </div>

        <!-- Specializations -->
        <div class="mb-4">
          <div class="flex flex-wrap gap-1">
            {% for spec in therapist.specializations_display|slice:":3" %}
              <span class="specialization-tag text-xs">{{ spec }}</span>
            {% endfor %}
            {% if therapist.specializations_display|length > 3 %}
              <span class="text-xs text-gray-500">+{{ therapist.specializations_display|length|add:-3 }} more</span>
            {% endif %}
          </div>
        </div>

        <!-- Session Types -->
        <div class="mb-4 flex items-center space-x-3 text-sm text-gray-600">
          {% if therapist.offers_video_sessions %}
            <div class="flex items-center">
              <i class="fas fa-video mr-1 text-blue-500"></i>
              <span>Video</span>
            </div>
          {% endif %}
          {% if therapist.offers_chat_sessions %}
            <div class="flex items-center">
              <i class="fas fa-comments mr-1 text-green-500"></i>
              <span>Chat</span>
            </div>
          {% endif %}
          {% if therapist.offers_in_person %}
            <div class="flex items-center">
              <i class="fas fa-handshake mr-1 text-purple-500"></i>
              <span>In-person</span>
            </div>
          {% endif %}
        </div>

        <!-- Bio Preview -->
        <p class="text-gray-600 text-sm font-dm leading-relaxed mb-4 line-clamp-3">
          {{ therapist.bio|truncatewords:25 }}
        </p>

        <!-- Insurance Badge -->
        {% if therapist.accepts_insurance %}
          <div class="mb-4">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              <i class="fas fa-shield-alt mr-1"></i>
              Accepts Insurance
            </span>
          </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="flex space-x-3">
          <a href="{% url 'therapists:therapist_detail' therapist.id %}" 
             class="flex-1 text-center px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all shadow-lg hover:shadow-xl font-dm">
            View Profile
          </a>
          <a href="{% url 'therapists:book_appointment' therapist.id %}" 
             class="px-4 py-3 border-2 border-purple-500 text-purple-500 font-semibold rounded-xl hover:bg-purple-500 hover:text-white transition-all font-dm">
            Book Now
          </a>
        </div>
      </div>
    {% empty %}
      <div class="col-span-full text-center py-12">
        <div class="mb-4">
          <i class="fas fa-search text-gray-300 text-6xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-600 mb-2 font-fredoka">No therapists found</h3>
        <p class="text-gray-500 font-dm mb-4">
          {% if has_search %}
            Try adjusting your search criteria or <a href="{% url 'therapists:therapist_list' %}" class="text-purple-600 hover:text-purple-800">browse all therapists</a>.
          {% else %}
            No therapists are available at the moment. Please check back later.
          {% endif %}
        </p>
      </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if therapists.has_other_pages %}
    <div class="mt-12 flex justify-center">
      <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
        {% if therapists.has_previous %}
          <a href="?page={{ therapists.previous_page_number }}{% if request.GET.search_query %}&search_query={{ request.GET.search_query }}{% endif %}" 
             class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
            <i class="fas fa-chevron-left"></i>
          </a>
        {% endif %}

        {% for num in therapists.paginator.page_range %}
          {% if num == therapists.number %}
            <span class="relative inline-flex items-center px-4 py-2 border border-purple-500 bg-purple-50 text-sm font-medium text-purple-600">
              {{ num }}
            </span>
          {% elif num > therapists.number|add:-3 and num < therapists.number|add:3 %}
            <a href="?page={{ num }}{% if request.GET.search_query %}&search_query={{ request.GET.search_query }}{% endif %}" 
               class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
              {{ num }}
            </a>
          {% endif %}
        {% endfor %}

        {% if therapists.has_next %}
          <a href="?page={{ therapists.next_page_number }}{% if request.GET.search_query %}&search_query={{ request.GET.search_query }}{% endif %}" 
             class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
            <i class="fas fa-chevron-right"></i>
          </a>
        {% endif %}
      </nav>
    </div>
  {% endif %}
</div>

<script>
document.getElementById('toggle-filters').addEventListener('click', function() {
  const filtersPanel = document.getElementById('filters-panel');
  const arrow = document.getElementById('filter-arrow');
  
  filtersPanel.classList.toggle('hidden');
  arrow.classList.toggle('fa-chevron-down');
  arrow.classList.toggle('fa-chevron-up');
});

// Auto-submit form when sort changes
document.addEventListener('DOMContentLoaded', function() {
  const sortSelect = document.querySelector('select[name="sort_by"]');
  if (sortSelect) {
    const form = sortSelect.closest('form');
    sortSelect.addEventListener('change', function() {
      form.submit();
    });
  }
});
</script>
{% endblock %}